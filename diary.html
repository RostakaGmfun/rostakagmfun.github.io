<!doctype html>
<html lang="en">
<head>
<title>RostakaGmfun's diary</title>
<!-- 2017-07-29 Sat 15:05 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Rostyslav Kurylo">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script type="text/javascript">
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">RostakaGmfun's diary</h1>
<p>
<i>Some notes on my daily software development adventures.</i>
</p>

<div id="outline-container-sec-" class="outline-2">
<h2 id="sec-">Underscores in org-mode</h2>
<div class="outline-text-2" id="text-">
<p>
I had a trouble with making `x86_64` correctly exported from org-mode to HTML.
The issue was caused by Org exporting characters after the underscore as subscript line.
Fortunately, there is an export option `^:` which allows to toggle Tex-like subscript/superscript syntax.
More info here: <a href="http://orgmode.org/manual/Export-settings.html">http://orgmode.org/manual/Export-settings.html</a>, half way down the page.
</p>
</div>
</div>
<div id="outline-container-pci-overview" class="outline-2">
<h2 id="pci-overview"><a id="sec-" name="sec-"></a>PCI overview</h2>
<div class="outline-text-2" id="text-pci-overview">
<p>
PCI is a widespread bus protocol for peripheral interconnection usually found on x86 platforms
(although originally designed with cross-platformness in mind).
It is quite outdated but I decided to go over it in detail in order to implement a driver for my x86_64 OS
and then possibly move to the PCIe which is a bit more complicated.
Below is a short summary of what I have learned so far:
</p>
<ul class="org-ul">
<li>PCI devices are organized into a tree: there are up to 256 buses with up to 32 devices on each bus.
</li>
<li>The PCI device can be controlled via the <i>Configuration space</i>. On x86 platform it can be accessed through the two 32-bit I/O ports.
The first one contains the offset within the Confiuration space and the second one contains the data to be read or written.
</li>
<li>On the conventional PCI the size of Configuration space can be as large as 256 bytes, 16 of them (first 4 32-bit registers) are mandatory.
</li>
<li>Each PCI device is uniquely identified by its DeviceID, VendorID, Class code, and Subclass code.
</li>
<li>The rest of registers are device-dependent. Among them: Base Address Registers (BARs) contain memory spaces
and/or I/O port spaces which serve as a comunication channels to the PCI device.
</li>
<li>The Capabilities pointer is an 4-byte aligned 8-bit address of first entry in the liked list of device <i>capabilities</i> located at the
tail of Configuration space.
</li>
<li>Each entry in capability list contains at least 2 bytes: capability id and <i>next</i> pointer (offset in configuration space).
The rest is device-specific data.
</li>
</ul>
</div>
</div>
<div id="outline-container-multibyte-i2c-transfer" class="outline-2">
<h2 id="multibyte-i2c-transfer"><a id="sec-" name="sec-"></a>Multibyte transfer over I<sup>2</sup>C bus</h2>
<div class="outline-text-2" id="text-multibyte-i2c-transfer">
<p>
I<sup>2</sup>C bus is a common hardware protocol to communicate with multiple low-speed peripherals located tightly on the board.
I<sup>2</sup>C is used mostly in the embedded devices
(one exception known to me is I<sup>2</sup>C-compatible modification called SMBus,
which is frequently used in laptop and desktop computers to communicate with power management subsystems).
That is why performance considerations are common when talking about I<sup>2</sup>C-enabled peripherals,
especially about those that consume or produce lots of data (like different kinds of sensors).
A minimal unidirectional one-byte transfer of I<sup>2</sup>C communication looks like this:
</p>

<ol class="org-ol">
<li>Master sends a START condition bit.
</li>
<li>Master sends a 7-bit (or 10-bit) slave address.
</li>
<li>Master sends a R/W bit.
</li>
<li>Slave sends ACK
</li>
<li>Master transfers or accepts an 8-bit packet of data to or form the requested slave.
</li>
<li>If the transfer was master-to-slave, the slave sends ACK bit, otherwise the master sends NACK bit.
</li>
<li>Master sends a STOP condition bit.
</li>
</ol>

<p>
The number of bits sent is 20 (for 7-bit salve address), so the total overhead to send one byte is 12 bits.
</p>

<p>
It is a common case for the master to first write a request (e.g register address) and then accept the reply from the slave.
This is possible by sending the <i>repeated START condition</i> just after the step 4.
The repeated START condition is then followed by steps 2-6 resulting in 11 bits overhead per data byte.
This way, the total overhead to transfer N bytes this way is <code>(1+7+1+1)*N+1</code> bits or <code>11*N+1</code> (for 7-bit slave address).
</p>

<p>
A good feature of I<sup>2</sup>C is to transfer multiple (unlimited!) number of bytes without going through the sequence of steps 2-6
to transfer every byte. This requires some support from the slave, though. The communication will look like this:
</p>

<ol class="org-ol">
<li>Master sends a START condition bit.
</li>
<li>Master sends a 7-bit (or 10-bit) slave address.
</li>
<li>Master sends a R/W bit.
</li>
<li>Slave sends ACK.
</li>
<li>Master sends repeated START condition bit.
</li>
<li>Master transfers or accepts a variable number of 8-bit packets of data to or from the requested slave.
The number of packets is specified by slave depending on its state.
For each transferred byte, a single ACK bit is required from master or slave depending on the transfer direction.
</li>
<li>Master sends a STOP condition bit.
</li>
</ol>

<p>
In this case, the overhead is only <code>1+7+1+1+N+1</code> bits or <code>11+N</code> bits per byte (for 7-bit slave address).
</p>

<p>
As a consequence, to transfer e.g. 32 bytes from the sensor, you will save <code>(11*32+1)-(11+32) = 310</code> bits, which is about 38 bytes
(even more than you actually intended to transfer!).
</p>

<p>
Another great advantage of multi-byte transfer is that it can be issued with the single DMA transaction, which causes more
efficient utilization of the DMA and gives the CPU more time either do more work or to save more power.
</p>
</div>
</div>
<div id="outline-container-verifying-multiboot-header" class="outline-2">
<h2 id="verifying-multiboot-header"><a id="sec-" name="sec-"></a>Verifying Multiboot header with grub-file</h2>
<div class="outline-text-2" id="text-verifying-multiboot-header">
<p>
As I started doing some bare-metal x86_64 development, I found out a useful tool to verify
if the GRUB multiboot header is correct. The <code>grub-file</code> command (In my case, the <code>grub2</code> package from NixOS channel)
accepts the executable and returns if it is correct via the exit code, which is is handy to use in automated builds:
</p>
<div class="org-src-container">

<pre class="src src-bash">grub-file --is-x86-multiboot my_kernel
</pre>
</div>
</div>
</div>
<div id="outline-container-using-nixops" class="outline-2">
<h2 id="using-nixops"><a id="sec-" name="sec-"></a>Trying out NixOps</h2>
<div class="outline-text-2" id="text-using-nixops">
<p>
I wanted to try out <a href="https://nixos.org/NixOps">NixOps</a> for long time and, finally, I've found some free time to play with it.
NixOps is an IaC (Infrastructure as Code) tool based on Nix, a purely functional package manager,
which I have been using together with <a href="https://nixos.org/NixOs">NixOs</a> Linux distribution for about two months.
</p>

<p>
Interestingly, this is a first time I've tried to use IaaC tools,
and I believe it is a good thing to go functional from the beginning :)
What I have done with NixOps so far, is a VirtualBox server with a NixOS container running Apache server with `Hello, world` page.
</p>

<p>
What is good about functional approach to infrastructure it the precise reproducibility of deployment
thanks to purity of Nix expressions.
An <i>expression</i>, a pure function in Nix, declaratively defines a software package
or the entire environment, which consits of multiple packages and system configurations.
Since the expressions are pure, the global state of the system is never mutated, which means that
it is impossible (well, in theory) to introduce broken states while redeploying with Nix.
</p>
</div>
</div>

<div id="outline-container-benchmarking" class="outline-2">
<h2 id="benchmarking"><a id="sec-" name="sec-"></a>Benchmarking my kv storage with google/benchmark</h2>
<div class="outline-text-2" id="text-benchmarking">
<p>
As I am learning about persistent key-value storages,
I decided to implement simple storage on my own in order to apply knowledge I have acquired.
</p>

<p>
I planned to go with simplest ever persistent key-value storage and improve it iteratively
by employing smart techniques I discover in some articles and <i>Designing Data-Intensive Applications</i> book.
</p>

<p>
In order to measure my progress, I started writing benchmarks using the <a href="https://github.com/google/benchmark">google/benchmark</a> library,
a feature-rich benchmarking framework for C++.
</p>
</div>
</div>

<div id="outline-container-bloom-filters-cuckoo-hashing" class="outline-2">
<h2 id="bloom-filters-cuckoo-hashing"><a id="sec-" name="sec-"></a>Key-value storages, bloom filter and cuckoo hashing</h2>
<div class="outline-text-2" id="text-bloom-filters-cuckoo-hashing">
<p>
I have been learning about design and architecture of persistent key-value storages for a few days,
and today I started reading a paper on <a href="http://www.vldb.org/pvldb/vldb2010/papers/I04.pdf">FlashStore</a>.
As I read through it, I had to google some info about <i>bloom filters</i> and <i>cuckoo hashing</i>.
</p>

<p>
A few notes on bloom filter:
</p>

<ul class="org-ul">
<li>Bloom filter is a probabilistic data structure that implements a <code>Set</code> abstract data type.
</li>
<li>Probabilistic means that operations on the DS don't give correct results all the time.
</li>
<li>Supports <code>add</code> and <code>test</code> operations with constant time complexity. <code>delete</code> is not supported in classic implementation (TODO: investigate).
</li>
<li><code>test</code> deterministically answers if the element is not present in the set but may emit false positives.
</li>
<li>Bloom filters are implemented as a bitmap and a number of hash functions, which produce bit positions.
</li>
<li><code>add</code> hashes the value with each hash function and sets corresponding bits to 1.
</li>
<li>To check if an element exists in a set, it is hashed and corresponding bits are compared.
</li>
<li>The smaller is the load factor, the smaller is the probability of false positives.
</li>
<li>Applications: quickly check if some data is present on slow storage to avoid reading from it.
</li>
<li><a href="https://www.jasondavies.com/bloomfilter/">Visualization</a>.
</li>
</ul>

<p>
A bit on cuckoo hashing:
</p>

<ul class="org-ul">
<li>Implements dictionary abstract data type with worst-case constant time for lookup (compare to traditional hash tables (open addressing/chaining) with linear worst-case lookup).
</li>
<li>Cuckoo hashing is implemented as two hash tables with independent hash functions thus providing two places where new element can be inserted.
</li>
<li>Collision occurs when both places are occupated.
</li>
<li>The collision is resolved with placing the other value at another hash table, hence the name cuckoo: new-born cuckoo birds throw their sibling eggs from the nest (I hadn't known this before!).
</li>
<li>The process of moving elements lasts until a free cell is found or a loop is detected. In the latter case the table is rehashed.
</li>
</ul>
</div>
</div>
<div id="outline-container-hello-org" class="outline-2">
<h2 id="hello-org"><a id="sec-" name="sec-"></a>First day using org-mode</h2>
<div class="outline-text-2" id="text-hello-org">
<p>
So I decided to maintain a list of tiny notes on programming-related topics, and because I have started using Emacs a few weeks ago, I took up org-mode for this.
</p>

<p>
Traditional blogging takes much time and skill and so I consider maintaining such a diary a perfect solution if you lack on of these (or both, as I do).
</p>

<p>
Furthermore, as a side profit, summarizing improves learning productivity.
</p>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-">Underscores in org-mode</a></li>
<li><a href="#pci-overview">PCI overview</a></li>
<li><a href="#multibyte-i2c-transfer">Multibyte transfer over I<sup>2</sup>C bus</a></li>
<li><a href="#verifying-multiboot-header">Verifying Multiboot header with grub-file</a></li>
<li><a href="#using-nixops">Trying out NixOps</a></li>
<li><a href="#benchmarking">Benchmarking my kv storage with google/benchmark</a></li>
<li><a href="#bloom-filters-cuckoo-hashing">Key-value storages, bloom filter and cuckoo hashing</a></li>
<li><a href="#hello-org">First day using org-mode</a></li>
</ul>
</div>
</nav>
</div></div></div>
<footer id="postamble" class="">
<div><p class="author">Author: Rostyslav Kurylo</p>
<p class="date">Created: 2017-07-29 Sat 15:05</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org-mode</a> 9.0.7)</p>
</div>
</footer>
</body>
</html>
